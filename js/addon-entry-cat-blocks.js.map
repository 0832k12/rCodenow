{"version":3,"file":"js/addon-entry-cat-blocks.js","sources":["webpack://GUI/./src/addons/addons/cat-blocks/_runtime_entry.js","webpack://GUI/./src/addons/addons/cat-blocks/userscript.js"],"sourcesContent":["/* generated by pull.js */\nimport _js from \"./userscript.js\";\nexport const resources = {\n  \"userscript.js\": _js,\n};\n","/**\n * Based on https://github.com/LLK/scratch-blocks/compare/hotfix/totally-normal-2021 (Apache 2.0)\n * It has been modified to work properly in our environment and fix some bugs.\n */\n\nexport default async function ({ addon, console }) {\n  const Blockly = await addon.tab.traps.getBlockly();\n\n  const shouldWatchMouseCursor = addon.settings.get(\"watch\");\n\n  Blockly.BlockSvg.START_HAT_HEIGHT = 31;\n\n  Blockly.BlockSvg.START_HAT_PATH =\n    \"c2.6,-2.3 5.5,-4.3 8.5,-6.2\" +\n    \"c-1,-12.5 5.3,-23.3 8.4,-24.8c3.7,-1.8 16.5,13.1 18.4,15.4\" +\n    \"c8.4,-1.3 17,-1.3 25.4,0c1.9,-2.3 14.7,-17.2 18.4,-15.4\" +\n    \"c3.1,1.5 9.4,12.3 8.4,24.8c3,1.8 5.9,3.9 8.5,6.1\";\n\n  Blockly.BlockSvg.TOP_LEFT_CORNER_DEFINE_HAT =\n    \"c0,-7.1 3.7,-13.3 9.3,-16.9c1.7,-7.5 5.4,-13.2 7.6,-14.2\" +\n    \"c2.6,-1.3 10,6 14.6,11.1h33c4.6,-5.1 11.9,-12.4 14.6,-11.1\" +\n    \"c1.9,0.9 4.9,5.2 6.8,11.1c2.6,0,5.2,0,7.8,0\";\n\n  Blockly.BlockSvg.prototype.renderCatFace_ = function () {\n    this.catPath_.svgFace.setAttribute(\"fill\", \"#000000\");\n\n    var closedEye = Blockly.utils.createSvgElement(\"path\", {}, this.svgFace_);\n    closedEye.setAttribute(\n      \"d\",\n      \"M25.2-1.1c0.1,0,0.2,0,0.2,0l8.3-2.1l-7-4.8\" +\n        \"c-0.5-0.3-1.1-0.2-1.4,0.3s-0.2,1.1,0.3,1.4L29-4.1l-4,1\" +\n        \"c-0.5,0.1-0.9,0.7-0.7,1.2C24.3-1.4,24.7-1.1,25.2-1.1z\"\n    );\n    closedEye.setAttribute(\"fill-opacity\", \"0\");\n    this.catPath_.svgFace.closedEye = closedEye;\n\n    var closedEye2 = Blockly.utils.createSvgElement(\"path\", {}, this.svgFace_);\n    closedEye2.setAttribute(\n      \"d\",\n      \"M62.4-1.1c-0.1,0-0.2,0-0.2,0l-8.3-2.1l7-4.8\" +\n        \"c0.5-0.3,1.1-0.2,1.4,0.3s0.2,1.1-0.3,1.4l-3.4,2.3l4,1\" +\n        \"c0.5,0.1,0.9,0.7,0.7,1.2C63.2-1.4,62.8-1.1,62.4-1.1z\"\n    );\n    closedEye2.setAttribute(\"fill-opacity\", \"0\");\n    this.catPath_.svgFace.closedEye2 = closedEye2;\n\n    var eye = Blockly.utils.createSvgElement(\"circle\", {}, this.svgFace_);\n    eye.setAttribute(\"cx\", \"59.2\");\n    eye.setAttribute(\"cy\", \"-3.3\");\n    eye.setAttribute(\"r\", \"3.4\");\n    eye.setAttribute(\"fill-opacity\", \"0.6\");\n    this.catPath_.svgFace.eye = eye;\n\n    var eye2 = Blockly.utils.createSvgElement(\"circle\", {}, this.svgFace_);\n    eye2.setAttribute(\"cx\", \"29.1\");\n    eye2.setAttribute(\"cy\", \"-3.3\");\n    eye2.setAttribute(\"r\", \"3.4\");\n    eye2.setAttribute(\"fill-opacity\", \"0.6\");\n    this.catPath_.svgFace.eye2 = eye2;\n\n    var mouth = Blockly.utils.createSvgElement(\"path\", {}, this.svgFace_);\n    mouth.setAttribute(\n      \"d\",\n      \"M45.6,0.1c-0.9,0-1.7-0.3-2.3-0.9\" +\n        \"c-0.6,0.6-1.3,0.9-2.2,0.9c-0.9,0-1.8-0.3-2.3-0.9c-1-1.1-1.1-2.6-1.1-2.8\" +\n        \"c0-0.5,0.5-1,1-1l0,0c0.6,0,1,0.5,1,1c0,0.4,0.1,1.7,1.4,1.7\" +\n        \"c0.5,0,0.7-0.2,0.8-0.3c0.3-0.3,0.4-1,0.4-1.3c0-0.1,0-0.1,0-0.2\" +\n        \"c0-0.5,0.5-1,1-1l0,0c0.5,0,1,0.4,1,1c0,0,0,0.1,0,0.2\" +\n        \"c0,0.3,0.1,0.9,0.4,1.2C44.8-2.2,45-2,45.5-2s0.7-0.2,0.8-0.3\" +\n        \"c0.3-0.4,0.4-1.1,0.3-1.3c0-0.5,0.4-1,0.9-1.1c0.5,0,1,0.4,1.1,0.9\" +\n        \"c0,0.2,0.1,1.8-0.8,2.8C47.5-0.4,46.8,0.1,45.6,0.1z\"\n    );\n    mouth.setAttribute(\"fill-opacity\", \"0.6\");\n\n    this.catPath_.ear.setAttribute(\n      \"d\",\n      \"M73.1-15.6c1.7-4.2,4.5-9.1,5.8-8.5\" +\n        \"c1.6,0.8,5.4,7.9,5,15.4c0,0.6-0.7,0.7-1.1,0.5c-3-1.6-6.4-2.8-8.6-3.6\" +\n        \"C72.8-12.3,72.4-13.7,73.1-15.6z\"\n    );\n    this.catPath_.ear.setAttribute(\"fill\", \"#FFD5E6\");\n\n    this.catPath_.ear2.setAttribute(\n      \"d\",\n      \"M22.4-15.6c-1.7-4.2-4.5-9.1-5.8-8.5\" +\n        \"c-1.6,0.8-5.4,7.9-5,15.4c0,0.6,0.7,0.7,1.1,0.5c3-1.6,6.4-2.8,8.6-3.6\" +\n        \"C22.8-12.3,23.2-13.7,22.4-15.6z\"\n    );\n    this.catPath_.ear2.setAttribute(\"fill\", \"#FFD5E6\");\n  };\n\n  Blockly.BlockSvg.prototype.initCatStuff = function () {\n    if (this.hasInitCatStuff) return;\n    this.hasInitCatStuff = true;\n\n    // Ear part of the SVG path for hat blocks\n    var LEFT_EAR_UP = \"c-1,-12.5 5.3,-23.3 8.4,-24.8c3.7,-1.8 16.5,13.1 18.4,15.4\";\n    var LEFT_EAR_DOWN = \"c-5.8,-4.8 -8,-18 -4.9,-19.5c3.7,-1.8 24.5,11.1 31.7,10.1\";\n    var RIGHT_EAR_UP = \"c1.9,-2.3 14.7,-17.2 18.4,-15.4c3.1,1.5 9.4,12.3 8.4,24.8\";\n    var RIGHT_EAR_DOWN = \"c7.2,1 28,-11.9 31.7,-10.1c3.1,1.5 0.9,14.7 -4.9,19.5\";\n    // Ears look slightly different for define hat blocks\n    var DEFINE_HAT_LEFT_EAR_UP = \"c0,-7.1 3.7,-13.3 9.3,-16.9c1.7,-7.5 5.4,-13.2 7.6,-14.2c2.6,-1.3 10,6 14.6,11.1\";\n    var DEFINE_HAT_RIGHT_EAR_UP = \"h33c4.6,-5.1 11.9,-12.4 14.6,-11.1c1.9,0.9 4.9,5.2 6.8,11.1c2.6,0,5.2,0,7.8,0\";\n    var DEFINE_HAT_LEFT_EAR_DOWN =\n      \"c0,-4.6 1.6,-8.9 4.3,-12.3c-2.4,-5.6 -2.9,-12.4 -0.7,-13.4c2.1,-1 9.6,2.6 17,5.8\" + \"c2.6,0 6.2,0 10.9,0\";\n    var DEFINE_HAT_RIGHT_EAR_DOWN = \"c0,0 25.6,0 44,0c7.4,-3.2 14.8,-6.8 16.9,-5.8c1.2,0.6 1.6,2.9 1.3,5.8\";\n\n    var that = this;\n    this.catPath_.ear = Blockly.utils.createSvgElement(\"path\", {}, this.catPath_);\n    this.catPath_.ear2 = Blockly.utils.createSvgElement(\"path\", {}, this.catPath_);\n    if (this.RTL) {\n      // Mirror the ears.\n      this.catPath_.ear.setAttribute(\"transform\", \"scale(-1 1)\");\n      this.catPath_.ear2.setAttribute(\"transform\", \"scale(-1 1)\");\n    }\n    this.catPath_.addEventListener(\"mouseenter\", function (event) {\n      clearTimeout(that.blinkFn);\n      // blink\n      if (event.target.svgFace.eye) {\n        event.target.svgFace.eye.setAttribute(\"fill-opacity\", \"0\");\n        event.target.svgFace.eye2.setAttribute(\"fill-opacity\", \"0\");\n        event.target.svgFace.closedEye.setAttribute(\"fill-opacity\", \"0.6\");\n        event.target.svgFace.closedEye2.setAttribute(\"fill-opacity\", \"0.6\");\n      }\n\n      // reset after a short delay\n      that.blinkFn = setTimeout(function () {\n        if (event.target.svgFace.eye) {\n          event.target.svgFace.eye.setAttribute(\"fill-opacity\", \"0.6\");\n          event.target.svgFace.eye2.setAttribute(\"fill-opacity\", \"0.6\");\n          event.target.svgFace.closedEye.setAttribute(\"fill-opacity\", \"0\");\n          event.target.svgFace.closedEye2.setAttribute(\"fill-opacity\", \"0\");\n        }\n      }, 100);\n    });\n\n    this.catPath_.ear.addEventListener(\"mouseenter\", function () {\n      clearTimeout(that.earFn);\n      clearTimeout(that.ear2Fn);\n      // ear flick\n      that.catPath_.ear.setAttribute(\"fill-opacity\", \"0\");\n      that.catPath_.ear2.setAttribute(\"fill-opacity\", \"\");\n      var bodyPath = that.catPath_.svgBody.getAttribute(\"d\");\n      bodyPath = bodyPath.replace(RIGHT_EAR_UP, RIGHT_EAR_DOWN);\n      bodyPath = bodyPath.replace(DEFINE_HAT_RIGHT_EAR_UP, DEFINE_HAT_RIGHT_EAR_DOWN);\n      bodyPath = bodyPath.replace(LEFT_EAR_DOWN, LEFT_EAR_UP);\n      bodyPath = bodyPath.replace(DEFINE_HAT_LEFT_EAR_DOWN, DEFINE_HAT_LEFT_EAR_UP);\n      that.catPath_.svgBody.setAttribute(\"d\", bodyPath);\n\n      // reset after a short delay\n      that.earFn = setTimeout(function () {\n        that.catPath_.ear.setAttribute(\"fill-opacity\", \"\");\n        var bodyPath = that.catPath_.svgBody.getAttribute(\"d\");\n        bodyPath = bodyPath.replace(RIGHT_EAR_DOWN, RIGHT_EAR_UP);\n        bodyPath = bodyPath.replace(DEFINE_HAT_RIGHT_EAR_DOWN, DEFINE_HAT_RIGHT_EAR_UP);\n        that.catPath_.svgBody.setAttribute(\"d\", bodyPath);\n      }, 50);\n    });\n    this.catPath_.ear2.addEventListener(\"mouseenter\", function () {\n      clearTimeout(that.earFn);\n      clearTimeout(that.ear2Fn);\n      // ear flick\n      that.catPath_.ear2.setAttribute(\"fill-opacity\", \"0\");\n      that.catPath_.ear.setAttribute(\"fill-opacity\", \"\");\n      var bodyPath = that.catPath_.svgBody.getAttribute(\"d\");\n      bodyPath = bodyPath.replace(LEFT_EAR_UP, LEFT_EAR_DOWN);\n      bodyPath = bodyPath.replace(DEFINE_HAT_LEFT_EAR_UP, DEFINE_HAT_LEFT_EAR_DOWN);\n      bodyPath = bodyPath.replace(RIGHT_EAR_DOWN, RIGHT_EAR_UP);\n      bodyPath = bodyPath.replace(DEFINE_HAT_RIGHT_EAR_DOWN, DEFINE_HAT_RIGHT_EAR_UP);\n      that.catPath_.svgBody.setAttribute(\"d\", bodyPath);\n\n      // reset after a short delay\n      that.ear2Fn = setTimeout(function () {\n        that.catPath_.ear2.setAttribute(\"fill-opacity\", \"\");\n        var bodyPath = that.catPath_.svgBody.getAttribute(\"d\");\n        bodyPath = bodyPath.replace(LEFT_EAR_DOWN, LEFT_EAR_UP);\n        bodyPath = bodyPath.replace(DEFINE_HAT_LEFT_EAR_DOWN, DEFINE_HAT_LEFT_EAR_UP);\n        that.catPath_.svgBody.setAttribute(\"d\", bodyPath);\n      }, 50);\n    });\n    if (this.RTL) {\n      // Set to the correct initial position\n      this.svgFace_.style.transform = \"translate(-87px, 0px)\";\n    }\n    if (this.shouldWatchMouse()) {\n      this.windowListener = function (event) {\n        var time = Date.now();\n        if (time < that.lastCallTime + that.CALL_FREQUENCY_MS) return;\n        that.lastCallTime = time;\n        if (!that.shouldWatchMouse()) return;\n\n        // mouse watching\n        if (that.workspace) {\n          // not disposed\n          var xy = that.getCatFacePosition();\n          var mouseLocation = {\n            x: event.x / that.workspace.scale,\n            y: event.y / that.workspace.scale,\n          };\n\n          var dx = mouseLocation.x - xy.x;\n          var dy = mouseLocation.y - xy.y;\n          var theta = Math.atan2(dx, dy);\n\n          // Map the vector from the cat face to the mouse location to a much shorter\n          // vector in the same direction, which will be the translation vector for\n          // the cat face\n          var delta = Math.sqrt(dx * dx + dy * dy);\n          var scaleFactor = delta / (delta + 1);\n\n          // Equation for radius of ellipse at theta for axes with length a and b\n          var a = 2;\n          var b = 5;\n          var r = (a * b) / Math.sqrt(Math.pow(b * Math.cos(theta), 2) + Math.pow(a * Math.sin(theta), 2));\n\n          // Convert polar coordinate back to x, y coordinate\n          dx = r * scaleFactor * Math.sin(theta);\n          dy = r * scaleFactor * Math.cos(theta);\n\n          if (that.RTL) dx -= 87; // Translate face over\n          that.svgFace_.style.transform = \"translate(\" + dx + \"px, \" + dy + \"px)\";\n        }\n      };\n      document.addEventListener(\"mousemove\", this.windowListener);\n    }\n  };\n\n  let workspacePositionRect = null;\n  Blockly.BlockSvg.prototype.getCatFacePosition = function () {\n    // getBoundingClientRect is not performant\n    //var offset = that.workspace.getParentSvg().getBoundingClientRect();\n    if (!workspacePositionRect) {\n      workspacePositionRect = this.workspace.getParentSvg().getBoundingClientRect();\n    }\n    var offset = { x: workspacePositionRect.x, y: workspacePositionRect.y };\n\n    if (!this.isInFlyout && this.workspace.getFlyout()) {\n      offset.x += this.workspace.getFlyout().getWidth();\n    }\n\n    offset.x += this.workspace.scrollX;\n    offset.y += this.workspace.scrollY;\n\n    var xy = this.getRelativeToSurfaceXY(this.svgGroup_);\n    if (this.RTL) {\n      xy.x = this.workspace.getWidth() - xy.x - this.width;\n    }\n    // convert to workspace units\n    xy.x += offset.x / this.workspace.scale;\n    xy.y += offset.y / this.workspace.scale;\n    // distance to center of face\n    xy.x -= 43.5;\n    xy.y -= 4;\n    // flyout category offset\n    xy.x += 60;\n    if (this.RTL) {\n      // We've been calculating from the right edge. Convert x to from left edge.\n      xy.x = screen.width - xy.x;\n    }\n    return xy;\n  };\n\n  Blockly.BlockSvg.prototype.shouldWatchMouse = function () {\n    if (!shouldWatchMouseCursor) return false;\n    // if (window.vmLoadHigh || !window.CAT_CHASE_MOUSE) return false;\n    var xy = this.getCatFacePosition();\n    const MARGIN = 50;\n    var blockXOnScreen = xy.x > -MARGIN && xy.x - MARGIN < screen.width / this.workspace.scale;\n    var blockYOnScreen = xy.y > -MARGIN && xy.y - MARGIN < screen.height / this.workspace.scale;\n    return this.startHat_ && !this.isGlowingStack_ && blockXOnScreen && blockYOnScreen;\n  };\n\n  const originalRenderDraw = Blockly.BlockSvg.prototype.renderDraw_;\n  Blockly.BlockSvg.prototype.renderDraw_ = function (...args) {\n    if (!this.svgFace_) {\n      this.sa_catBlockConstructor();\n    }\n    const r = originalRenderDraw.call(this, ...args);\n    if (!this.outputConnection && !this.previousConnection) {\n      this.initCatStuff();\n    }\n    if (this.startHat_ && !this.svgFace_.firstChild) {\n      this.renderCatFace_();\n    }\n    return r;\n  };\n\n  const originalDispose = Blockly.BlockSvg.prototype.dispose;\n  Blockly.BlockSvg.prototype.dispose = function (...args) {\n    clearTimeout(this.blinkFn);\n    clearTimeout(this.earFn);\n    clearTimeout(this.ear2Fn);\n    if (this.windowListener) {\n      document.removeEventListener(\"mousemove\", this.windowListener);\n    }\n    return originalDispose.call(this, ...args);\n  };\n\n  const originalSetGlowStack = Blockly.BlockSvg.prototype.setGlowStack;\n  Blockly.BlockSvg.prototype.setGlowStack = function (isGlowingStack) {\n    if (this.windowListener) {\n      if (isGlowingStack) {\n        // For performance, don't follow the mouse when the stack is glowing\n        document.removeEventListener(\"mousemove\", this.windowListener);\n        if (this.workspace && this.svgFace_.style) {\n          // reset face direction\n          if (this.RTL) {\n            this.svgFace_.style.transform = \"translate(-87px, 0px)\";\n          } else {\n            this.svgFace_.style.transform = \"\";\n          }\n        }\n      } else {\n        document.addEventListener(\"mousemove\", this.windowListener);\n      }\n    }\n    return originalSetGlowStack.call(this, isGlowingStack);\n  };\n\n  Blockly.BlockSvg.prototype.sa_catBlockConstructor = function () {\n    this.catPath_ = Blockly.utils.createSvgElement(\"g\", {}, this.svgGroup_);\n\n    this.svgFace_ = Blockly.utils.createSvgElement(\"g\", {}, this.catPath_);\n    this.catPath_.svgFace = this.svgFace_;\n    this.catPath_.svgBody = this.svgPath_;\n    this.lastCallTime = 0;\n    this.CALL_FREQUENCY_MS = 60;\n  };\n\n  const workspace = Blockly.getMainWorkspace();\n  if (workspace) {\n    const vm = addon.tab.traps.vm;\n    if (vm.editingTarget) {\n      vm.emitWorkspaceUpdate();\n    }\n    const flyout = workspace.getFlyout();\n    if (flyout) {\n      const flyoutWorkspace = flyout.getWorkspace();\n      Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.workspaceToDom(flyoutWorkspace), flyoutWorkspace);\n      workspace.getToolbox().refreshSelection();\n      workspace.toolboxRefreshEnabled_ = true;\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AADA;;;;;;;;;;;;ACFA;AAAA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAEA;AAEA;AAEA;AAMA;AACA;AAIA;AACA;AAEA;AACA;AAMA;AACA;AAEA;AACA;AAMA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAWA;AAEA;AAMA;AAEA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAFA;AAKA;AACA;AACA;AAGA;AACA;AACA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;A","sourceRoot":""}